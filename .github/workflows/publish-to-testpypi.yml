name: Publish pre-release package

on:
  push:
    branches:
    - topic/github-actions

jobs:
  check-style:
    name: Check source code style
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: Set up Python 3.6
      uses: actions/setup-python@v1
      with:
        python-version: 3.6
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --user black flake8 isort mypy
    - run: isort --check-only
    - run: black --check syphon tests setup.py
    - run: flake8
    - run: mypy

  test:
    name: Run unit tests
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 3
      matrix:
        os: [macOS-latest, ubuntu-latest, windows-latest]
        python-version: [3.6, 3.7]
    steps:
    - uses: actions/checkout@v1
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --user pipenv
        pipenv install --skip-lock
        pipenv run pip install pytest pytest-cov
    - name: pytest
      run: pipenv run pytest --verbose --cov=syphon --cov-report=xml --slow
    - name: Upload to Codecov
      uses: codecov/codecov-action@v1.0.2
      with:
        token: ${{ secrets.codecov }}
        file: coverage.xml
        name: syphon-ghactions-${{ matrix.python-version }}

  build-publish:
    name: Build and publish a pre-release package
    needs: [check-style, test]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: Set up Python 3.6
      uses: actions/setup-python@v1
      with:
        python-version: 3.6
    - name: Install pep517
      run: |
        python -m pip install --upgrade pip
        pip install --user pep517
    - name: Build wheel and source tarball
      run: >
        python -m
        pep517.build
        --source
        --binary
        --out-dir dist/
        .
    - name: Publish distribution to TestPyPI
      uses: pypa/gh-action-pypi-publish@master
      with:
        password: ${{ secrets.test_pypi_password }}
        repository_url: https://test.pypi.org/legacy/
